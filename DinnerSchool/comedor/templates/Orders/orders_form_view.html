{% extends "main.html" %} {% load static %} {% block content %}
<script src="{% static 'js/orders.js' %}"></script>
<!-- Select2 CSS & JS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<div
  class="bg-white p-8 rounded-lg shadow-xl max-w-4xl w-full border-t-8 border-primary-red"
>
  <div class="flex flex-col items-center mb-6">
    <!-- Logo -->
    <img
      src="{% static 'img/logos/logo.png' %}"
      alt="Logo de la Cafetería Certo"
      class="w-20 h-20 mb-4 rounded-full border-2 border-primary-red p-1 object-cover"
    />
    <h1 class="text-3xl font-bold text-gray-800 mb-2">Crear Nueva Orden</h1>
    <p class="text-gray-600 text-center">Agrega platillos a tu carrito de compras</p>
  </div>

  <!-- Bloque para mensajes -->
  {% if messages %}
  <div class="mb-4" style="margin-top: 1.5rem">
    {% for message in messages %}
    <div
      class="p-3 rounded-md text-center text-sm font-medium {% if message.tags == 'success' %}bg-green-100 text-green-800 border border-green-200{% elif message.tags == 'error' %}bg-red-100 text-red-800 border border-red-200{% elif message.tags == 'warning' %}bg-yellow-100 text-yellow-800 border border-yellow-200{% elif message.tags == 'info' %}bg-blue-100 text-blue-800 border border-blue-200{% else %}bg-gray-100 text-gray-800 border border-gray-200{% endif %}"
    >
      {{ message }}
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    <!-- Formulario para agregar platillos -->
    <div class="space-y-4">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">Agregar Platillo</h2>
      
      <!-- Platillo -->
      <div>
        <label for="platillo" class="block text-sm font-medium text-gray-700 mb-1"
          >Platillo*</label
        >
        <select
          id="platillo"
          name="platillo"
          class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary-red focus:border-primary-red sm:text-sm"
        >
          <option value="">Selecciona el Platillo</option>
          {% for platillo in Platillos %}
          <option
            value="{{ platillo.id }}"
            data-precio="{{ platillo.precio }}"
            data-ingredientes="{{ platillo.ingredientes}}"
            data-nombre="{{ platillo.nombre }}"
          >
            {{ platillo.nombre }} - ${{ platillo.precio }}
          </option>
          {% endfor %}
        </select>
      </div>

      <!-- Ingredientes -->
      <div>
        <label
          for="ingredientes-display"
          class="block text-sm font-medium text-gray-700 mb-1"
          >Ingredientes</label
        >
        <textarea
          id="ingredientes-display"
          rows="3"
          readonly
          class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100 sm:text-sm"
          placeholder="Los ingredientes aparecerán aquí..."
        ></textarea>
      </div>

      <!-- Notas -->
      <div>
        <label for="notas" class="block text-sm font-medium text-gray-700 mb-1"
          >Notas</label
        >
        <input
          type="text"
          id="notas"
          name="notas"
          placeholder="Ejemplo: Sin cebolla"
          class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary-red focus:border-primary-red sm:text-sm"
        />
      </div>

      <!-- Cantidad -->
      <div>
        <label for="cantidad" class="block text-sm font-medium text-gray-700 mb-1"
          >Cantidad*</label
        >
        <input
          type="number"
          id="cantidad"
          name="cantidad"
          min="1"
          value="1"
          class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary-red focus:border-primary-red sm:text-sm"
        />
      </div>

      <!-- Turno -->
      <div>
        <label for="turno" class="block text-sm font-medium text-gray-700 mb-1"
          >Turno*</label
        >
        <select
          id="turno"
          name="turno"
          class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary-red focus:border-primary-red sm:text-sm"
        >
          <option value="">Selecciona el Horario de Comida</option>
          <option value="0">Receso 1</option>
          <option value="1">Receso 2</option>
          <option value="2">Comida</option>
        </select>
      </div>

      <!-- Botón para agregar al carrito -->
      <button
        type="button"
        id="addToCart"
        class="w-full px-6 py-2 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-green-600 hover:bg-green-700"
      >
        Agregar al Carrito
      </button>
    </div>

    <!-- Carrito de compras -->
    <div class="space-y-4">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">Carrito de Compras</h2>
      
      <div id="cart-items" class="space-y-2 max-h-96 overflow-y-auto">
        <p class="text-gray-500 text-center py-8">El carrito está vacío</p>
      </div>

      <!-- Total -->
      <div class="border-t pt-4">
        <div class="flex justify-between items-center mb-4">
          <span class="text-lg font-semibold">Total:</span>
          <span id="total-amount" class="text-xl font-bold text-primary-red">$0.00</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Información del pedido (fuera del grid) -->
   {% if is_admin or is_tutor %}
  <div class="mt-8 pt-6 border-t space-y-4">
    <h3 class="text-lg font-semibold text-gray-800">Información del Pedido</h3>
    
    {% if is_tutor %}
    <!-- Alumno -->
    <div>
      <label
        for="alumno_tutor"
        class="block text-sm font-medium text-gray-700 mb-1"
        >Alumno*</label
      >
      <select
        id="alumno_tutor"
        name="alumno"
        class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary-red focus:border-primary-red sm:text-sm"
        required
      >
        <option value="">Selecciona el Alumno</option>
        {% for alumno in Alumnos %}
        <option value="{{ alumno.id }}">{{ alumno.nombre }}</option>
        {% endfor %}
      </select>
    </div>
    {% endif %} 
    
    {% if is_admin %}
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label for="tutor" class="block text-sm font-medium text-gray-700 mb-1">Tutor*</label>
        <div class="relative">
          <input
            type="text"
            id="tutor-search"
            placeholder="Buscar tutor o profesor..."
            class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary-red focus:border-primary-red sm:text-sm"
            autocomplete="off"
          />
          <div class="absolute right-2 top-1/2 transform -translate-y-1/2 pointer-events-none">
            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </div>
          
          <!-- Select oculto para enviar el valor -->
          <select id="tutor" name="tutor" required class="hidden">
            <option value="">Selecciona el tutor</option>
            {% for tutor in tutors %}
              <option value="{{ tutor.id }}">{{ tutor.nombre }}</option>
            {% endfor %}
          </select>
          
          <!-- Lista desplegable personalizada -->
          <div id="tutor-dropdown" class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg hidden max-h-60 overflow-y-auto">
            <div id="tutor-options">
              {% for tutor in tutors %}
                <div class="tutor-option px-4 py-2 hover:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-b-0" 
                     data-value="{{ tutor.id }}" 
                     data-type="{{ tutor.type }}"
                     data-search="{{ tutor.nombre|lower }}{% for alumno in Alumnos %}{% if alumno.tutor_id == tutor.id %} {{ alumno.nombre|lower }}{% endif %}{% endfor %}">
                  <div class="font-medium text-sm">{{ tutor.nombre|cut:" - Tutor"|cut:" - Profesor" }}</div>
                  <div class="text-xs text-gray-500 flex justify-between items-center">
                    {% if tutor.type == 'Tutor' %}
                      <span class="italic"> Alumnos:
                      {% for alumno in Alumnos %}
                        {% if alumno.tutor_id == tutor.id %}
                          {{ alumno.nombre }}{% if not forloop.last %},{% endif %}
                        {% endif %}
                        {% endfor %}
                      </span>
                    {% else %}
                      <span class="italic"> Profesor</span>
                    {% endif %}
                  </div>
                </div>
              {% endfor %}
            </div>
            <div id="no-results" class="px-4 py-2 text-gray-500 text-sm hidden">
              No se encontraron resultados
            </div>
          </div>
        </div>
      </div>
      
      <div>
        <label for="alumno" class="block text-sm font-medium text-gray-700 mb-1">Alumno*</label>
        <select
          id="alumno"
          name="alumno"
          class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary-red focus:border-primary-red sm:text-sm"
        >
          <option value="">Selecciona un tutor primero</option>
          {% for alumno in Alumnos %}
          <option value="{{ alumno.id }}" data-tutor-id="{{ alumno.tutor_id }}">
            {{ alumno.nombre }}
          </option>
          {% endfor %}
        </select>
        <span class="help-block" style="color: red;"><small>Recuerda que si seleccionas un Tutor, este campo es obligatorio.</small></span>
      </div>
    </div>
    {% endif %}
  </div>
  {% endif %}

  <!-- Botones finales -->
  <div class="flex justify-end space-x-4 pt-6 mt-6 border-t">
    <a
      href="{% url 'core:dashboard' %}"
      class="px-6 py-2 border border-gray-300 rounded-md shadow-sm text-base font-medium text-gray-700 bg-white hover:bg-gray-50"
    >
      Descartar
    </a>
    <button
      type="button"
      id="clearCart"
      class="px-6 py-2 border border-gray-300 rounded-md shadow-sm text-base font-medium text-gray-700 bg-white hover:bg-gray-50"
    >
      Limpiar Carrito
    </button>
    <button
      type="button"
      id="submitOrder"
      class="px-6 py-2 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-primary-red hover:bg-red-700"
      disabled
    >
      Solicitar Orden
    </button>
  </div>

  <!-- Formulario oculto para envío -->
  <form
    action="{% url 'comedor:createOrder' %}"
    method="post"
    id="ordersForm"
    style="display: none;"
  >
    {% csrf_token %}
    <input type="hidden" id="cart-data" name="cart_data" />
    <input type="hidden" id="final-alumno" name="alumno" />
    <input type="hidden" id="final-tutor" name="tutor" />
    <input type="hidden" id="final-total" name="total" />
  </form>

  <div
    id="message"
    class="mt-6 p-3 text-sm text-center rounded-md hidden"
  ></div>
</div>

{% endblock %}
